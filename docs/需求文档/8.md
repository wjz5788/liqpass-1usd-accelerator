ç»“è®ºå…ˆç»™ä½ ï¼š**ä¸è¦â€œé‡æ–°å†™ä¸€éâ€**ã€‚ç”¨â€œç§»æ¤èƒ½åŠ›â€çš„æ–¹å¼æ›´ç¨³ï¼šæŠŠåŸæ¥åç«¯é‡Œè·Ÿ A ç›¸å…³çš„æ–‡ä»¶ **æ‹·è¿›å¤§é¡¹ç›®çš„æŒ‡å®šä½ç½®**ï¼Œç„¶åè®© AI **æŒ‰ä½ çš„æ–°ç»“æ„æ”¹è·¯å¾„/é…ç½®/è¡¨å**ã€‚è¿™æ ·é”™è¯¯æ›´å°‘ã€è¿›åº¦æ›´å¿«ã€‚

---

## 1) å…ˆå®ç° Aï¼šé‡æ–°å†™ vs è¿ç§»ä¿®æ”¹ï¼Œæˆ‘æ¨èå“ªä¸€ä¸ªï¼Ÿ

âœ… **æ¨èï¼šè¿ç§»+ä¿®æ”¹ï¼ˆä¼˜å…ˆï¼‰**
é€‚ç”¨æ¡ä»¶ï¼šä½ åŸæ¥åç«¯å·²ç»æœ‰ jp-verify clientã€DB/migrationsã€claim æµç¨‹çš„ä¸€éƒ¨åˆ†ã€‚

åšæ³•åƒâ€œå™¨å®˜ç§»æ¤â€ï¼š

* åªç§»æ¤ A éœ€è¦çš„å™¨å®˜ï¼š`claims/` `admin/` `jpVerifyClient` `db/migrations`
* å…¶ä½™ä¸šåŠ¡å…ˆåˆ«å¸¦ï¼ˆé¿å…æŠŠæ—§é¡¹ç›®çš„è€¦åˆä¸€èµ·å¸¦è¿›æ¥ï¼‰

ğŸš« **ä¸æ¨èï¼šå®Œå…¨é‡å†™**
åŸå› ï¼šA è¿™å—æ¶‰åŠå¹‚ç­‰ã€çª—å£æ ¡éªŒã€è¯æ®å…¥åº“ã€çŠ¶æ€æœºï¼Œä¸€é‡å†™å°±å®¹æ˜“æ¼è¾¹ç•Œæ¡ä»¶ï¼Œçº¿ä¸Šæœ€å®¹æ˜“ç‚¸çš„å°±æ˜¯è¿™ç§åœ°æ–¹ã€‚

---

## 2) ä½ è¿™æ£µç»“æ„æ ‘æ˜¯å¦å¯ä»¥ï¼Ÿ

**å¯ä»¥**ï¼Œè€Œä¸”ä½ ç°åœ¨å·²ç»æœ‰â€œdomains/insuranceâ€å‰ç«¯æ¨¡å—ï¼Œè¿™æ˜¯å¾ˆå¥½çš„åº•åº§ã€‚
ç¼ºçš„åªæ˜¯ï¼š**åç«¯è¦è½åœ¨å¤§ä»“åº“çš„ä¸€ä¸ªæ˜ç¡®ä½ç½®**ï¼ˆå»ºè®® `apps/*`ï¼‰ã€‚

### æ¨èæ–°å¢ï¼ˆå¤§é¡¹ç›®å†…ï¼‰

```
apps/
  liqpass-backend/          # A çš„å…¨éƒ¨åç«¯éƒ½åœ¨è¿™
    src/
      modules/claims/
      modules/admin/
      services/jpVerify/
      db/
        migrations/
```

å‰ç«¯ä¸åŠ¨ï¼š`src/domains/insurance` ç»§ç»­å½“ UI æ¨¡å—ã€‚

---

## 3) contracts æ–‡ä»¶å¤¹æœªæ¥è¦å¡ 3 ä¸ªé¡¹ç›®æ‰€æœ‰åˆçº¦ï¼Œåˆç†å—ï¼Ÿ

âœ… **åˆç†ï¼Œä½†è¦â€œåˆ†åŒ…/åˆ†åŸŸâ€**ã€‚å¦åˆ™åé¢ ABIã€éƒ¨ç½²è„šæœ¬ã€åœ°å€ç®¡ç†ä¼šäº’ç›¸æ±¡æŸ“ã€‚

### æ¨è contracts ç»“æ„ï¼ˆå¯æ‰©å±•åˆ° N ä¸ªé¡¹ç›®ï¼‰

```
contracts/
  foundry.toml                # æ€»å…¥å£ï¼ˆæˆ–ç”¨ workspace é£æ ¼ï¼‰
  libs/                        # å…±äº«åº“ï¼ˆå¯é€‰ï¼‰
  liqpass-insurance/           # ä¿é™©åˆçº¦åŸŸ
    src/
    script/
    abi/
  accelerator/                 # 1USD/åŠ é€Ÿå™¨åˆçº¦åŸŸ
    src/
    script/
    abi/
  other-project-1/             # ä½ è¯´çš„å¦å¤–ä¸‰ä¸ªä¹‹ä¸€
    src/
    script/
    abi/
```

### ä¸‰æ¡ç¡¬è§„åˆ™ï¼ˆä¿è¯ä¸ä¼šä¹±ï¼‰

1. **æ¯ä¸ªåŸŸè‡ªå·±çš„éƒ¨ç½²è„šæœ¬**ï¼š`contracts/<domain>/script/*`
2. **æ¯ä¸ªåŸŸè‡ªå·±çš„åœ°å€ç°¿**ï¼š`deployments/<chainId>/<domain>.json`
3. **ABI åªä»åŸŸé‡Œå¯¼å‡º**ï¼šå‰ç«¯ç”¨ `src/web3/abi/<domain>/...json`

è¿™æ ·ä½ æŠŠ 4 ä¸ªé¡¹ç›®çš„åˆçº¦éƒ½æ”¾è¿›æ¥ï¼Œä¹Ÿä¸ä¼šäº’ç›¸è¸©è„šã€‚

---

## 4) â€œåŒä¸€ä¸ª foundry.toml ç®¡æ‰€æœ‰åˆçº¦â€è¡Œä¸è¡Œï¼Ÿ

è¡Œï¼Œä½†æˆ‘æ›´æ¨èä¸¤ç§ä¹‹ä¸€ï¼š

* **æ–¹æ¡ˆ Aï¼ˆç®€å•ï¼‰**ï¼šä¸€ä¸ª `foundry.toml`ï¼Œæ‰€æœ‰åŸŸéƒ½åœ¨ `src = "contracts"` ä¸‹ï¼Œé€šè¿‡ç›®å½•åŒºåˆ†
* **æ–¹æ¡ˆ Bï¼ˆæ›´å¹²å‡€ï¼‰**ï¼šæ¯ä¸ªåŸŸä¸€ä¸ª foundry é¡¹ç›®ï¼ˆå„è‡ª foundry.tomlï¼‰ï¼Œç”¨è„šæœ¬ç»Ÿä¸€ç¼–è¯‘/å¯¼å‡º ABI

ä½ ç°åœ¨é˜¶æ®µï¼šé€‰ **æ–¹æ¡ˆ A**ï¼Œå¿«ã€‚

---

## 5) ä½ ç°åœ¨è¯¥æ€ä¹ˆè®© AI å¹²æ´»ï¼ˆæœ€å°‘æŒ‡ä»¤ç‰ˆï¼‰

ä½ ç»™ TraeAI çš„æŒ‡ä»¤å°±ä¸€å¥è¯ï¼Œåˆ«è®©å®ƒè‡ªç”±å‘æŒ¥ï¼š

**æŒ‡ä»¤æ¨¡æ¿ï¼š**

1. åœ¨å¤§ä»“åº“æ–°å¢ `apps/liqpass-backend`ï¼ˆåªå®ç° Aï¼‰
2. ä»æ—§åç«¯å¤åˆ¶ `claims/admin/jpVerify/db migrations` åˆ°å¯¹åº”ç›®å½•
3. æ”¹åŠ¨ç‚¹åªå…è®¸ï¼š

   * è·¯å¾„/é…ç½®ï¼ˆenvã€dbè¿æ¥ï¼‰
   * è¡¨å/å­—æ®µå¯¹é½ï¼ˆpurchase_orders + insurance_claimsï¼‰
   * æ¥å£è·¯ç”±æŒ‚è½½
4. ç¦æ­¢é‡æ„æ— å…³æ¨¡å—ã€ç¦æ­¢æ”¹ä¸šåŠ¡è¯­ä¹‰

---

## 6) ä½ é—®çš„æ ¸å¿ƒæ‹…å¿ƒï¼šåˆåˆ°ä¸€å—ä¼šä¸ä¼šå‡ºé—®é¢˜ï¼Ÿ

åªè¦ä½ åšåˆ°è¿™ä¸¤ç‚¹ï¼Œå°±**åŸºæœ¬ä¸ä¼šå‡ºå¤§é—®é¢˜**ï¼š

* **åç«¯è¿›ç¨‹éš”ç¦»**ï¼ˆapps ä¸‹å•ç‹¬è·‘ï¼Œä¸è·Ÿ Vite æ··ï¼‰
* **åˆçº¦åˆ†åŸŸéš”ç¦»**ï¼ˆdomain å­ç›®å½• + åœ°å€ç°¿åˆ†æ–‡ä»¶ï¼‰

è¿™ä¿©å°±æ˜¯â€œé˜²ä¸²å‘³â€çš„éš”ç¦»å¢™ã€‚

---

å¦‚æœä½ ç°åœ¨è¦æˆ‘ç»™ä½ ä¸€ä¸ªâ€œæœ€ç»ˆç›®å½•è½ä½å›¾â€ï¼ˆæŠŠ A çš„æ¯ä¸ªæ–‡ä»¶æ”¾å“ªï¼Œå‘½åæ€ä¹ˆå®šï¼Œæ¥å£è·¯å¾„æ€ä¹ˆæŒ‚ï¼‰ï¼Œæˆ‘å¯ä»¥ç›´æ¥æŠŠ **ç›®å½•+æ–‡ä»¶æ¸…å•**åç»™ä½ ï¼Œä½ ç…§ç€è®© AI å»ºå°±è¡Œã€‚
ä½ åœ¨ä»“åº“ /Volumes/01_hard/web3/liqpass-1usd-accelerator å†…æ“ä½œã€‚

ç›®æ ‡ï¼šæ–°å¢åç«¯ apps/liqpass-backendï¼Œå®ç° Phase Aï¼š
- DBï¼šinsurance_claims è¡¨ + å¹‚ç­‰å”¯ä¸€ç´¢å¼• UNIQUE(purchase_order_id, okx_event_id)
- å†…éƒ¨æ¥å£ï¼šPOST /internal/claims/onchain-trigger
- Adminï¼šGET /admin/claims?status=VERIFIED_PENDING_REVIEW
        POST /admin/claims/:claimId/approve
        POST /admin/claims/:claimId/reject
        POST /admin/claims/:claimId/mark-paid
- jp-verify clientï¼šverify(ordId, instId) æ‹‰ evidence_jsonï¼Œå­˜ evidence_root/evidence_json/liquidation_time_ms
- 24h çª—å£æ ¡éªŒï¼šcoverage_start_at <= liquidation_time <= coverage_end_at
- payout è®¡ç®—ï¼šä» purchase_orders.policy_params_json è¯» payout_fixed_usdc / payout_cap_usdcï¼Œpayout=min(fixed,cap)
- çŠ¶æ€æœºï¼šVERIFYING -> VERIFIED_PENDING_REVIEWï¼ˆä¸è‡ªåŠ¨æ‰“æ¬¾ï¼‰

ã€ç¡¬æ€§çº¦æŸã€‘
1) åªå®ç° Aï¼Œä¸è¦åš listenerï¼Œä¸è¦æ”¹åˆçº¦ï¼Œä¸è¦æ”¹å‰ç«¯é¡µé¢ã€‚
2) åç«¯è¦ç‹¬ç«‹è¿›ç¨‹ï¼Œç›®å½•å¿…é¡»æ˜¯ apps/liqpass-backendã€‚
3) æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»å¹‚ç­‰ï¼šåŒä¸€ purchase_order_id + okx_event_id é‡æ”¾ä¸é‡å¤åˆ›å»º claimã€‚
4) ordId/instId ä» purchase_orders.okx_meta_json è¯»å–ï¼›ç¼ºå¤±åˆ™æŠŠ claim æ ‡è®° FAILED å¹¶å†™ rejected_reason=MISSING_OKX_METAã€‚
5) ä¸è¦å¤§é‡æ„ï¼šåªæ–°å¢å¿…è¦æ–‡ä»¶ï¼›è‹¥ç¼º purchase_orders å­—æ®µï¼Œä»…æä¾› migration å¢åŠ å­—æ®µã€‚

ã€æ‰§è¡Œæ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰ã€‘
Step 1: åˆå§‹åŒ–åç«¯å·¥ç¨‹
- åˆ›å»º apps/liqpass-backend/package.jsonï¼ˆNode 18+ï¼‰
- ä½¿ç”¨ TypeScript + Fastifyï¼ˆæˆ– Expressï¼‰ä»»é€‰å…¶ä¸€ï¼Œä½†è¦æœ‰æ¸…æ™°åˆ†å±‚ï¼šroutes/services/db
- å¢åŠ  .env.exampleï¼šDATABASE_URLã€JP_VERIFY_BASE_URLã€INTERNAL_API_KEYã€ADMIN_API_KEY

Step 2: DB è¿ç§»ï¼ˆç”¨ node-pg + è‡ªå·±å†™ migrationsï¼Œæˆ–ç”¨ drizzle/prisma ä»»ä¸€éƒ½è¡Œï¼›ä½†å¿…é¡»æœ‰å¯è¿è¡Œçš„ migrate å‘½ä»¤ï¼‰
- åˆ›å»º migration 001_add_purchase_orders_fields.sqlï¼š
  ä¸º purchase_orders å¢åŠ ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰ï¼š
    paid_at TIMESTAMPTZ
    coverage_start_at TIMESTAMPTZ
    coverage_end_at TIMESTAMPTZ
    quote_hash TEXT
    premium_amount_usdc NUMERIC(38,6)
    chain_id INT
    policy_type TEXT
    policy_params_json JSONB
    okx_meta_json JSONB
- åˆ›å»º migration 002_create_insurance_claims.sqlï¼š
  å»ºè¡¨ insurance_claimsï¼ˆå­—æ®µè§ä¸‹æ–¹ï¼‰
  å¹¶åˆ›å»ºå”¯ä¸€ç´¢å¼• UNIQUE(purchase_order_id, okx_event_id)

insurance_claims å­—æ®µæœ€å°é›†åˆï¼š
- id UUID PK default gen_random_uuid()
- purchase_order_id TEXT NOT NULL
- claimant TEXT NOT NULL
- submit_tx_hash TEXT
- triggered_at_sec BIGINT
- okx_event_id TEXT NOT NULL
- status TEXT NOT NULL
- evidence_root TEXT
- evidence_json JSONB
- liquidation_time_ms BIGINT
- coverage_window_start TIMESTAMPTZ
- coverage_window_end TIMESTAMPTZ
- payout_amount_usdc NUMERIC(38,6)
- payout_cap_usdc NUMERIC(38,6)
- approved_by TEXT
- approved_at TIMESTAMPTZ
- rejected_reason TEXT
- multisig_safe TEXT
- multisig_tx_hash TEXT
- paid_at TIMESTAMPTZ
- created_at TIMESTAMPTZ default now()
- updated_at TIMESTAMPTZ default now()

Step 3: å®ç° jp-verify client
- æ–‡ä»¶ï¼šapps/liqpass-backend/src/services/jpVerifyClient.ts
- æ–¹æ³•ï¼šverify({ordId, instId}) -> è¿”å› evidence_json
- ä» evidence_json æå–ï¼š
  evidence_root = evidence.root
  liquidation_time_ms = evidence.meta.fillTime ?? evidence.meta.cTime ?? evidence.fillTime ?? evidence.cTime

Step 4: å®ç° /internal/claims/onchain-trigger
- è·¯ç”±ï¼šapps/liqpass-backend/src/routes/internalClaims.ts
- é‰´æƒï¼šHeader x-internal-key == INTERNAL_API_KEY
- å…¥å‚ï¼š
  { purchaseOrderId, claimant, submitTxHash, triggeredAtSec }
- é€»è¾‘ï¼š
  1) æŸ¥ purchase_orders by purchaseOrderId
     è¦æ±‚ paid_at ä¸ä¸ºç©ºï¼›ä¸” coverage_start_at/coverage_end_at ä¸ä¸ºç©ºï¼ˆå¦åˆ™ 409ï¼‰
  2) ä» okx_meta_json å– ordId/instIdï¼›æ²¡æœ‰åˆ™ upsert claim(status=FAILED,rejected_reason=MISSING_OKX_META) å¹¶è¿”å› 200
  3) okx_event_id="ordId:"+ordId
  4) å…ˆ upsert å å‘ claimï¼šstatus=VERIFYINGï¼ˆON CONFLICT(purchase_order_id,okx_event_id) DO UPDATE updated_atï¼‰
  5) è°ƒ jp-verify æ‹‰ evidence_jsonï¼Œä¿å­˜ evidence_root/evidence_json/liquidation_time_ms
  6) è®¡ç®— liquidation_time = to_timestamp(liquidation_time_ms/1000)
     æ ¡éªŒæ˜¯å¦åœ¨ coverage_start_at..coverage_end_at
     - è‹¥ä¸åœ¨ï¼šæ›´æ–° claim(status=REJECTED,rejected_reason=OUT_OF_COVERAGE_WINDOW) å¹¶è¿”å› 200
  7) payout è®¡ç®—ï¼š
     - ä» purchase_orders.policy_params_json è¯» payout_fixed_usdc / payout_cap_usdcï¼ˆç¼ºçœ cap=0 è¡¨ç¤ºä¸èµ”ï¼‰
     - payout = min(payout_fixed_usdc, payout_cap_usdc)
  8) æ›´æ–° claimï¼š
     status=VERIFIED_PENDING_REVIEW
     coverage_window_start/end
     payout_amount_usdc/payout_cap_usdc
     evidence_root/evidence_json/liquidation_time_ms

Step 5: å®ç° Admin å®¡æ ¸æ¥å£
- è·¯ç”±ï¼šapps/liqpass-backend/src/routes/adminClaims.ts
- é‰´æƒï¼šHeader x-admin-key == ADMIN_API_KEY
- GET /admin/claims?status=VERIFIED_PENDING_REVIEWï¼šåˆ†é¡µå¯é€‰
- POST /admin/claims/:claimId/approveï¼š
   ä»…å…è®¸ä» VERIFIED_PENDING_REVIEW -> APPROVED_PENDING_MULTISIG
   å†™ approved_byï¼ˆå›ºå®šå†™ "admin" ä¹Ÿè¡Œï¼‰ã€approved_at=now()
- POST /admin/claims/:claimId/rejectï¼š
   å†™ status=REJECTED + rejected_reason(æ¥è‡ª body)
- POST /admin/claims/:claimId/mark-paidï¼š
   ä»…å…è®¸ä» APPROVED_PENDING_MULTISIG -> PAID
   body: { multisigTxHash, paidAtSec }
   å†™ multisig_tx_hashã€paid_at

Step 6: å¯åŠ¨ä¸æµ‹è¯•
- æ·»åŠ  npm scriptsï¼š
  - dev: tsx watch src/index.ts
  - migrate: è¿è¡Œ migrations
- åˆ›å»º apps/liqpass-backend/src/index.tsï¼š
  - è¯»å– env
  - æ³¨å†Œ routesï¼š/internal/claims/onchain-trigger å’Œ /admin/claims...
  - ç›‘å¬ç«¯å£ 3001
- å†™ä¸€ä¸ª scripts/mock_trigger.sh æˆ– scripts/mock_trigger.tsï¼š
  - å‘ /internal/claims/onchain-trigger å‘ mock è¯·æ±‚ï¼ˆpurchaseOrderId ä½ å…ˆéšä¾¿å†™ï¼Œä½†è¦æç¤ºæˆ‘éœ€è¦å…ˆæ’å…¥ä¸€æ¡ purchase_orders æµ‹è¯•æ•°æ®ï¼‰

ã€è¾“å‡ºè¦æ±‚ã€‘
1) ç»™æˆ‘ä¸€ä¸ªâ€œæ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•â€
2) ç»™æˆ‘æœ¬åœ°è¿è¡ŒæŒ‡ä»¤ï¼šcd apps/liqpass-backend && npm i && npm run migrate && npm run dev
3) ç»™æˆ‘ 2 æ¡ curlï¼š
   - internal trigger çš„ curl
   - admin list çš„ curl
/Users/zhaomosheng/Desktop/LiqPass/
â”œâ”€â”€ apps/                    # åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ us-backend/         # Node.js åç«¯ API (ç«¯å£: 3002)
â”‚   â”œâ”€â”€ us-frontend/      # React å‰ç«¯åº”ç”¨ (ç«¯å£: 3000)
â”‚   â”œâ”€â”€ chain-listener/   # åŒºå—é“¾äº‹ä»¶ç›‘å¬å™¨
â”‚   â”œâ”€â”€ jp-verify/        # Python éªŒè¯æœåŠ¡ (ç«¯å£: 8082)
â”‚   â””â”€â”€ youtube-uploader/ # å·¥å…·æœåŠ¡
â”œâ”€â”€ contracts/              # æ™ºèƒ½åˆçº¦
â”‚   â””â”€â”€ CheckoutUSDC.sol  # å½“å‰æ‰“å¼€çš„åˆçº¦æ–‡ä»¶
â”œâ”€â”€ packages/               # å…±äº«åŒ…
â”œâ”€â”€ docs/                   # æŠ€æœ¯æ–‡æ¡£
â”œâ”€â”€ scripts/                # éƒ¨ç½²è„šæœ¬
â””â”€â”€ tests/                  # æµ‹è¯•å¥—ä»¶