行，我把你“3 份报告”的精华合成**一份可直接执行的最终版**。你照着做就能落地，不再来回争论。

---

# LiqPass 单仓多模块架构执行方案（最终合并版）

适用对象：`liqpass-1usd-accelerator`（Vite + React + React Router + Wagmi/RainbowKit）
目标：一个仓库承载多业务模块（Accelerator / Insurance / Arena / Strategies），**低耦合、可扩展、可移除、可灰度**，并为未来“独立部署”留通道。

---

## 0) 一句话结论

**现在选 L1：单仓单 App（modular monolith）+ 模块 manifest 注册表 + 严格边界门禁。**
当你明确“独立发布=独立部署/回滚”时，升级到 **L2：单仓 monorepo 多 App**。
微前端（L3）先不碰，除非你满足触发条件。

---

## 1) “独立发布”三档（把口径写死，避免跑偏）

* **L1 同产物同部署**：模块级 feature flag/灰度，发布仍是一个 SPA 产物
  ✅ 你现在就做这个
* **L2 同仓多产物**：每个模块一个 app，可独立部署/回滚
  ✅ 三个月后如果需要独立回滚就上
* **L3 运行时微前端**：Module Federation / single-spa 等
  ⚠️ 等你规模化再说

---

## 2) 四条硬 Gate（你只要守住就不会崩）

### Gate 1：域隔离（CI 必须硬失败）

* `src/domains/*` **禁止** import 其它 `src/domains/*`

### Gate 2：钱包唯一入口（CI 必须硬失败）

* `src/domains/**` **禁止**直接 import `wagmi` / `@rainbow-me/*`
* 只能通过 `src/wallet/*`（或未来 `src/infra/web3/*`）调用钱包能力

### Gate 3：状态隔离（防 God Store）

* `src/store/*` 只允许平台状态：`wallet/session/ui`
* 业务状态必须在：`domains/<module>/store/*`

### Gate 4：可移除性（真实演练）

* 删除任意 `src/domains/<module>` 后，只改 `src/app/modules.ts` 就能 build/run

---

## 3) 目录结构（最小改动版，直接落地）

```
src/
  app/
    router.tsx                 # 只负责装配 routes（不写业务判断）
    modules.ts                 # 模块注册表（核心）
    routes/types.ts
    guards/
  wallet/                      # 当前继续用（后续可迁到 infra/web3）
    WalletProvider.tsx
    WalletButton.tsx
    useSyncWalletToStore.ts
    wagmi.ts
    chains.ts
  infra/                       # 新增（逐步迁移）
    http/
      client.ts                # http client factory（可注入）
    web3/
      chains.ts                # 统一链配置（从 wallet/chains.ts 迁移）
    observability/
      logger.ts
      analytics.ts
  shared/
    types/
    utils/
  components/
    common/                    # 无业务语义
    layout/
  domains/
    accelerator/
      manifest.ts              # 模块唯一对外入口（描述，不做 await）
      routes.ts
      pages/
      components/
      services/
      store/
      contracts/
      search/
    insurance/
      manifest.ts
      routes.ts
      ...
    arena/
      manifest.ts
      routes.ts
      ...
    strategies/                # 建议从 stocks 重命名（或反过来统一）
      manifest.ts
      routes.ts
      ...
```

---

## 4) 模块 manifest 规范（关键：manifest 只描述，Shell 负责加载）

### 4.1 Manifest 类型（放 `src/app/modules.types.ts`）

* `id / basePath`
* `routesLoader: () => Promise<Routes>`
* `navItems`
* 可选 `init()`（仅做模块内初始化，禁止跨模块逻辑）

### 4.2 `src/app/modules.ts`（模块注册表）

* 只 import 每个模块的 `manifest.ts`
* 任何模块的“启用/禁用”只改这里
  ✅ 这就是“可移除性”的开关

### 4.3 router 装配规则

* `router.tsx` 只做：

  * 读取 `enabledModules`
  * 调用 `routesLoader`
  * 聚合成 Router
* 禁止在 router 里写 `if(path===...)` 这种业务判断
  ✅ 守卫靠 route meta（见第 6 节）

---

## 5) 共享策略（允许 vs 禁止）

### ✅ 允许共享（平台级必须一致）

* 钱包、链配置、RPC、签名规范（`wallet/` 或未来 `infra/web3/`）
* 统一 http client（但必须可注入）
* UI primitives（Button/Card/Modal）
* 统一日志/埋点（必须带 `moduleId`）
* 通用类型（Address/Role/ChainId）
* 统一 guards（RequireWallet/RequireRole）

### ❌ 禁止共享（会把你搞崩）

* 业务 store 跨模块共享
* 定价/风控/结算逻辑共享（除非抽成纯函数包且有 owner）
* 合约 ABI/地址跨模块共享
* 业务组件（ProjectCard/PolicyCard）放进 common

### ⚠️ 条件共享（需要 owner + 稳定接口）

* `lmsr/market` 等算法：

  * 只给 accelerator 用 → 放 `domains/accelerator/domain/*`
  * 多模块都用 → 抽 `shared/quant/*`（纯函数，无 React/网络）

---

## 6) 路由与守卫（别再靠字符串判断）

### 6.1 路由必须前缀化

* `/accelerator/*`
* `/insurance/*`
* `/arena/*`
* `/strategies/*`

### 6.2 route meta（必加）

每条 route 带：

* `moduleId`
* `walletRequired`
* `requiredRole`

守卫读取 meta，不允许 router 里写 path 判断。

---

## 7) 工程门禁（让规则自动执行）

最低配置（必须做）：

* ESLint `no-restricted-imports`

  * 禁止 `domains/*` 互相 import
  * 禁止 `domains/*` 直接 import wagmi/rainbowkit
* 进入 CI：`lint + typecheck + test`

增强（建议做）：

* `eslint-plugin-boundaries` 或 `dependency-cruiser`
* “可移除性演练”脚本（本地执行即可）

---

## 8) 性能指标（给 Gate 一个数字，不然都在嘴上）

默认目标（Demo 可稍放宽）：

* 首屏 JS（gzip）≤ **500KB**（Demo 上限 800KB）
* build 时间 ≤ **90s**（本机）
* 访问 `/accelerator/*` 时 Network 不应请求 `insurance` 业务 chunk

验证方式：

* `vite-bundle-visualizer`
* 浏览器 Network 面板

---

## 9) 迁移执行计划（按 PR 切片，保证不炸）

### PR#1（壳）：模块注册表 + manifest

* 新增：`src/app/modules.ts`、各模块 `manifest.ts`
* router 改为从 modules 注册表聚合 routes
* 验收：不改业务逻辑，功能不变

### PR#2（封口）：钱包唯一入口

* 全项目搜索并清除 domain 内 `@rainbow-me/*`、`wagmi` 直接引用
* 统一使用 `wallet/WalletButton` 和 `wallet` hooks
* 验收：所有页面连接钱包行为一致

### PR#3（隔离）：accelerator 业务 store/services 下沉

* `src/store/projectsStore.ts` → `domains/accelerator/store/*`
* `src/services/accelerator.ts` → `domains/accelerator/services/*`
* 验收：其它模块不再依赖 accelerator 的 store/service

### PR#4（统一命名）：stocks vs strategies 对齐

* 目录、路由、导入路径一致
* 验收：所有路由正常，搜索/导航不乱

### PR#5（门禁）：边界规则进 CI

* ESLint 边界规则 + CI hard fail
* 验收：跨域 import 立即报错

---

## 10) 你现在立刻开干的“最小 5 件事”（今天就能完成）

1. 加 `src/app/modules.ts`（注册表）
2. 每个域加 `manifest.ts`（只描述，不 await）
3. 把保险页里任何 ConnectButton 直连全部干掉，统一走 WalletButton
4. 把 `projectsStore` 下沉到 accelerator 域
5. ESLint 两条边界规则写上并跑通

---

### 最后一句话

你按这个执行，**单仓承载多模块绝对不会出问题**。
后续要不要走 L2（多 app 独立部署）只看你是否真的需要“独立回滚/独立发版”，到时候再升级，不提前背成本。

如果你下一步要我继续：把你现在仓库里“PR#1 的改动点清单（文件级）”我也能给你列出来，让你直接丢给 AI 去写。
